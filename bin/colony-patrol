#!/usr/bin/env bash
#
# Colony Patrol - Strict execution with fresh context per milestone
#
# This script provides an alternative to /colony-deploy that uses
# a bash outer loop with `claude -p` for each milestone, ensuring
# fresh context and preventing context drift.
#
# Usage:
#   colony-patrol <project> [options]
#
# Options:
#   --autonomous    Run without pausing between milestones
#   --verbose       Show detailed progress (stream-json parsing)
#   --model <model> Override the model for orchestration (default: from config)
#
# Example:
#   colony-patrol my-project --autonomous
#   colony-patrol my-project --verbose
#

set -euo pipefail

# Get script directory for relative paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLI="${SCRIPT_DIR}/colony"
PARSER="${SCRIPT_DIR}/colony-progress-parser"

# Colors
if [[ -t 1 ]]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  BLUE='\033[0;34m'
  CYAN='\033[0;36m'
  BOLD='\033[1m'
  NC='\033[0m'
else
  RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' NC=''
fi

# Parse arguments
PROJECT=""
AUTONOMOUS=false
VERBOSE=false
MODEL=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --autonomous) AUTONOMOUS=true; shift ;;
    --verbose) VERBOSE=true; shift ;;
    --model) MODEL="$2"; shift 2 ;;
    --help|-h)
      echo "Usage: colony-patrol <project> [--autonomous] [--verbose] [--model <model>]"
      exit 0
      ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) PROJECT="$1"; shift ;;
  esac
done

if [[ -z "$PROJECT" ]]; then
  echo -e "${RED}Error: Project name required${NC}" >&2
  echo "Usage: colony-patrol <project> [--autonomous] [--verbose] [--model <model>]"
  exit 1
fi

# Get model from config if not overridden
if [[ -z "$MODEL" ]]; then
  MODEL=$("$CLI" get-model orchestrator 2>/dev/null | tail -1)
  [[ "$MODEL" == "inherit" ]] && MODEL="sonnet"
fi

# Verify project exists
if ! "$CLI" state get "$PROJECT" >/dev/null 2>&1; then
  echo -e "${RED}Error: Project '$PROJECT' not found${NC}" >&2
  echo "Available projects:"
  "$CLI" state list
  exit 1
fi

echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}${CYAN}  Colony Patrol - Fresh Context Execution${NC}"
echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "Project: ${BLUE}$PROJECT${NC}"
echo -e "Model: ${BLUE}$MODEL${NC}"
echo -e "Autonomous: ${BLUE}$AUTONOMOUS${NC}"
echo -e "Verbose: ${BLUE}$VERBOSE${NC}"
echo ""

# Get working directory
WORKING_DIR=$("$CLI" working-dir)
PROJECT_DIR="${WORKING_DIR}/colony/${PROJECT}"

# Main loop - one iteration per milestone
MILESTONE_COUNT=0
while true; do
  MILESTONE_COUNT=$((MILESTONE_COUNT + 1))

  # Get current milestone
  MILESTONE=$("$CLI" milestone current "$PROJECT")

  if [[ "$MILESTONE" == "COMPLETE" ]]; then
    echo ""
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}${BOLD}  All milestones complete!${NC}"
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
    break
  fi

  echo ""
  echo -e "${YELLOW}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
  echo -e "${YELLOW}${BOLD}  Milestone: $MILESTONE (iteration $MILESTONE_COUNT)${NC}"
  echo -e "${YELLOW}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
  echo ""

  # Build the orchestration prompt
  ORCHESTRATOR_PROMPT="You are a Colony orchestrator executing milestone $MILESTONE for project $PROJECT.

IMPORTANT: You have fresh context. Read state and context files to understand current status.

## Your Task

1. Read project state: $PROJECT_DIR/state.json
2. Read project context: $PROJECT_DIR/context.md
3. For each task in this milestone that is pending:
   - Check dependencies are complete
   - Spawn a worker using Task tool (subagent_type: colony:worker)
   - Wait for worker result
   - Spawn an inspector using Task tool (subagent_type: colony:inspector)
   - Update task status via CLI:
     - Success: $CLI state log $PROJECT inspection_started '{\"task\": \"TASK_ID\"}' && $CLI state task-complete $PROJECT TASK_ID
     - Failure: $CLI state task-fail $PROJECT TASK_ID \"reason\"

4. When all tasks in milestone $MILESTONE are complete, output exactly:
   MILESTONE_COMPLETE: $MILESTONE

5. If a task is stuck after 3 attempts, output:
   MILESTONE_STUCK: $MILESTONE - reason

## Worker Prompt Template
For each task, spawn a worker with:
- subagent_type: colony:worker
- Prompt: Read $PROJECT_DIR/tasks/TASK_ID.md and $PROJECT_DIR/context.md, execute the task, write log to $PROJECT_DIR/logs/TASK_ID_LOG.md

## Inspector Prompt Template
After worker completes, spawn inspector with:
- subagent_type: colony:inspector
- Prompt: Verify task TASK_ID. Read $PROJECT_DIR/tasks/TASK_ID.md and $PROJECT_DIR/logs/TASK_ID_LOG.md. Run verification command. Return PASS or FAIL.

## CLI Reference
- $CLI state summary $PROJECT     # View current state
- $CLI state task-start $PROJECT TASK_ID
- $CLI state task-complete $PROJECT TASK_ID
- $CLI state task-fail $PROJECT TASK_ID \"error\"
- $CLI state log $PROJECT EVENT '{\"key\": \"value\"}'

Now read the state files and execute milestone $MILESTONE."

  # Run the orchestrator with fresh context
  echo -e "${CYAN}Starting orchestrator with fresh context...${NC}"

  if [[ "$VERBOSE" == "true" ]]; then
    # Stream JSON output through parser for visibility
    RESULT=$(claude -p "$ORCHESTRATOR_PROMPT" --model "$MODEL" --output-format stream-json --verbose 2>&1 | tee >(${PARSER} >&2) | tail -1)
  else
    # Simple text output
    RESULT=$(claude -p "$ORCHESTRATOR_PROMPT" --model "$MODEL" 2>&1)
    echo "$RESULT"
  fi

  # Check result
  if echo "$RESULT" | grep -q "MILESTONE_COMPLETE"; then
    echo ""
    echo -e "${GREEN}✓ Milestone $MILESTONE complete${NC}"

    # Advance to next milestone
    "$CLI" milestone advance "$PROJECT"

    # Pause for user approval in non-autonomous mode
    if [[ "$AUTONOMOUS" == "false" ]]; then
      echo ""
      echo -e "${YELLOW}Milestone $MILESTONE finished. Continue to next milestone?${NC}"
      read -p "[y/n/q] " -n 1 -r
      echo
      case "$REPLY" in
        y|Y) echo "Continuing..." ;;
        n|N) echo "Paused. Run 'colony-patrol $PROJECT' to continue."; exit 0 ;;
        q|Q) echo "Quit."; exit 0 ;;
        *) echo "Invalid input. Pausing."; exit 0 ;;
      esac
    fi

  elif echo "$RESULT" | grep -q "MILESTONE_STUCK"; then
    echo ""
    echo -e "${RED}✗ Milestone $MILESTONE stuck${NC}"
    echo "$RESULT" | grep "MILESTONE_STUCK"

    if [[ "$AUTONOMOUS" == "false" ]]; then
      echo ""
      echo -e "${YELLOW}What would you like to do?${NC}"
      echo "  r) Retry milestone with fresh context"
      echo "  s) Skip to next milestone"
      echo "  q) Quit"
      read -p "[r/s/q] " -n 1 -r
      echo
      case "$REPLY" in
        r|R) echo "Retrying..."; continue ;;
        s|S) echo "Skipping..."; "$CLI" milestone advance "$PROJECT" ;;
        q|Q) echo "Quit."; exit 1 ;;
        *) echo "Invalid input. Quitting."; exit 1 ;;
      esac
    else
      echo -e "${RED}Autonomous mode: stopping on stuck milestone${NC}"
      exit 1
    fi

  else
    # Unexpected result - check if progress was made
    echo ""
    echo -e "${YELLOW}Orchestrator finished without clear completion signal.${NC}"

    # Check if milestone is actually complete
    if [[ "$("$CLI" milestone complete? "$PROJECT")" == "true" ]]; then
      echo -e "${GREEN}Milestone tasks are complete. Advancing...${NC}"
      "$CLI" milestone advance "$PROJECT"
    else
      echo -e "${YELLOW}Some tasks may still be pending. Check state:${NC}"
      "$CLI" state summary "$PROJECT"

      if [[ "$AUTONOMOUS" == "false" ]]; then
        read -p "Continue? [y/n] " -n 1 -r
        echo
        [[ "$REPLY" != "y" && "$REPLY" != "Y" ]] && exit 1
      fi
    fi
  fi

  # Safety: prevent infinite loops
  if [[ $MILESTONE_COUNT -gt 20 ]]; then
    echo -e "${RED}Error: Too many iterations (>20). Possible infinite loop.${NC}"
    exit 1
  fi
done

# Final summary
echo ""
"$CLI" state summary "$PROJECT"
echo ""
echo -e "${GREEN}Colony Patrol complete!${NC}"
